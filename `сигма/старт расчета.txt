-- Скрипт для ОЭК, архивация нескольких сбойных групповых расчетов
update calc_session cs set arc_id=-2 where calc_type=0 and calc_session_date_e is null and arc_id=0;
update calc_session cs set arc_id=-420 where arc_id=0 and account_per_id=2002;
select * from calc_session cs order by cs.calc_session_date_b desc;
update prior_calc set job_name=null,session_id=null ,prior_num=null,stream_num= null,is_fon=1 ;
update rglobal set rglobal_string='01', rglobal_number=01 where rglobal_id=71;
commit;
begin
  dbms_scheduler.run_job( 'JOB_FOR_STREAMS', false);
end;
/

-- Далее обычный скрипт для ПЭС, ПСК
update prior_calc set job_name=null,session_id=null ,prior_num=null,stream_num= null,is_fon=1 ;
select * from prior_calc set job_name=null,session_id=null ,prior_num=null,stream_num= null,is_fon=1 ;
select * from RGLOBAL r where r.rglobal_id = 71;
select rglobal_number from RGLOBAL r where r.rglobal_id = 71;
update rglobal set rglobal_string='21', rglobal_number=21 where rglobal_id=71;
select * from rglobal r where r.rglobal_number = 18;
select * from rglobal r where r.rglobal_code like '%STREAM%' for update;
select sysdate from dual;
commit;
select * from dba_scheduler_jobs;
select 

begin
  dbms_scheduler.run_job( 'JOB_FOR_STREAMS', false);
end;

select * from gv$session;
select * from dba_scheduler_job_log l where l.JOB_NAME = 'JOB_FOR_STREAMS';
select * from dba_scheduler_job_run_details de where de.JOB_NAME  = 'JOB_FOR_STREAMS';

--- Kill STREAMs
select 'alter system kill session '''||sid||','||serial#||''';' line from gv$session where action like '%FON%';
select 'alter system kill session '''||sid||','||serial#||',@'||inst_id||''';' line from gv$session where action like '%STREAM%';
select 'alter system disconnect session '''||sid||','||serial#||',@'||inst_id||''' immediate;' line from gv$session where action like '%FON%';
select * from sys.aud$;

--- Run one STREAM, use _current session_
begin
  admission.init_user_context('admpes');
  shipment.calc_all_abons(33); --номер потока
  commit;
end;

select *  from prior_calc;
select * from calc_session s where s.account_per_id = 2005 and s.calc_session_date_b > sysdate - 1 order by s.calc_session_date_b desc;

select * from c_terra t where t.terra_id in (22987, 22755, 22171, 22217);
